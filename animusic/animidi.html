<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.sound.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
</head>
<body>
<script>

var print = console.log;
var pi = Math.PI,
    sin = Math.sin,
    cos = Math.cos;

var PITCH_NAME = "A",
    PITCH_NUM  = 4,
    PITCH_FREQ = 440;
var FPS = 30;
var PITCH_NAMES   = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
// var chords = [
    // ["C","E","G"],
    // ["C","D#","G"],
    // ["C","E","G#"],
    // ["C","D#","F#"],
// ];

// MidiToTabConverter
//   https://tabnabber.com/MidiToTabConverter.aspx

// Fur Elise by Beethoven - Piano Letter Notes
//   https://pianoletternotes.blogspot.com/2015/11/fur-elise-by-beethoven.html
// Sky High by Elektronomia
//   https://pianoletternotes.blogspot.com/2019/06/sky-high-by-elektronomia.html
// Can Can by Offenbach
//   https://pianoletternotes.blogspot.com/2017/10/can-can-by-offenbach.html

var notes = [];

// Note: pitch [duration (seconds)] [start time]
//      duration: >n (dure n seconds) | (default, 0.5 seconds or 30 frames)
//      start time: +/-n (shift +/- n seconds) | ^n (at n seconds) | (default, just after last note) 
// C#4-4-2
// C# == C#4-4-1

// function parseNote(note) {
//     var info = note.match(/([CDEFGAB]#?)?(\d+)?(?:-(\d+)?)?(?:-(\d+)?)?/i);
//     // "C#4-8-1": ["C#4-8-1", "C#", "4", "8", "1"]
//     var pitch_name  = (info[1] || PITCH_NAME);
//     var pitch_num   = (info[2] || PITCH_NUM);
//     var note_value  = (info[3] || NOTE_VALUE);
//     var repeat      = (info[4] || 1);
//     var parsed_note = [pitch_name, pitch_num, note_value, repeat];
//     // print(parsed_note);
//     return parsed_note;
// }



// // Piano key frequencies
// //   https://en.wikipedia.org/wiki/Piano_key_frequencies
// // Frequencies for equal-tempered scale, A4 = 440 Hz
// //   http://pages.mtu.edu/~suits/notefreqs.html
// function pitch2freq(pitch_name, pitch_num) {
//     var base_index = PITCH_NAMES.indexOf(PITCH_NAME);
//     var pitch_index = PITCH_NAMES.indexOf(pitch_name);
//     var index_diff = (pitch_index - base_index) + (pitch_num - PITCH_NUM) * 12;
//     var pitch_freq = PITCH_FREQ * Math.pow(2, index_diff/12)
//     // print(pitch_name,pitch_num,index_diff,pitch_freq);
//     return pitch_freq;
// }

function dispFPS() {
    var fpsx=50,fpsy=50;
    push();
    textSize(20);
    textAlign(LEFT);
    fill(255);

    text(int(frameRate()), fpsx, fpsy);
    text(frameCount, fpsx+50, fpsy);
    pop();
}

Note = function (freq=440,dura=30) {
    this.x;
    this.y;
    this.size;
    this.color=[0,255,0,255];
    this.text;
    this.freq=freq;
    this.dura=dura;
    this.osc = new p5.SinOsc();
    this.osc.amp(1);
    this.osc.freq(this.freq);
    this.isStart = false;
    // this.show = function(){
    //     push();

    //     colorMode(RGB,255);
    //     fill.apply(null,this.color);
    //     noStroke();
    //     textSize(30);

    //     circle(this.x,this.y,this.size);

    //     textAlign(CENTER,TOP);
    //     text(this.text,this.x,this.y+50);

    //     pop();
    // }

    this.play = function() {
        if (this.isStart == false) {
            this.osc.start();
            this.isStart = true;
        }
        if (this.dura==0) {
            this.osc.stop();
        } else {
            this.dura -= 1;
        }
    }
}

// function dispOctave(){
//     var letterLeftX = 50, letterLeftY = 60;
//     var letterRightX = windowWidth-50, letterRightY = 60;

//     var leftOctave=3, rightOctave=5;
//     // var letterX=letterLeftX, letterY=letterLeftY;
//     var letterCX = windowWidth/2, letterCY = windowHeight/2;
//     var letterCR = windowHeight/2.5;
//     var letterNum = (rightOctave-leftOctave+1)*12;
//     var letterAngle = 0;
//     for (let i=leftOctave; i<=rightOctave; ++i) {
//         for (let j=0; j<PITCH_NAMES.length; ++j) {
//             letterName = PITCH_NAMES[j]+""+i;
//             // letterX += (letterRightX-letterLeftX)/((rightOctave-leftOctave+1)*12);
//             // letterY += (letterRightY-letterLeftY)/((rightOctave-leftOctave+1)*12);
//             letterAngle += 2*pi/letterNum; 
//             letterX = letterCX + letterCR * cos(letterAngle);
//             letterY = letterCY + letterCR * sin(letterAngle);
//             fill(255);
//             textSize(18);
//             text(letterName,letterX,letterY);
//         }
//     }
// }

var interval = 40;
// note: pitch, duration
function genNotes() {
    if (frameCount%interval != 0) {
        return false;
    }

    while (notes.length>=2) {
        // notes[0].stop();
        notes.shift();
    }

    freq_tmp = int(240+Math.random()*(640-240));
    dura_tmp = 50;
    note_tmp = new Note(freq_tmp,dura_tmp);
    notes.push(note_tmp);
}

// function dispNotes() {

// }
// var rand = myArray[Math.floor(Math.random() * myArray.length)];

function playNotes() {
    for(let i=0; i<notes.length-1; ++i) {
        note = notes[i];
        note.play();
    }
}

function setup(){
    createCanvas(windowWidth, windowHeight);
    background(0);
    frameRate(30);
}

function draw(){
    background(0);
    dispFPS();
    genNotes();
    playNotes();
}

</script>
</body>
</html>